#!/usr/bin/env node

var fs = require('fs');
var path = require('path');

var options = {
  browser: String
};

var shorthands = {
  b: '--browser'
};

var nopt = require('nopt')(options, shorthands);
var help = require('../lib/nopt-help');
var file = nopt.argv.remain[0];

if (nopt.help || !file) return help(options, shorthands, { program: 'sauce-browsertime-html' })
  .desc('browser', 'Browser under test (used to match browser logo)')
  .usage(function() {
    console.log('Usage: sauce-browsertime-html [options] file.json');
    console.log('');
    console.log('    $ sauce-browsertime results.json > index.html');
    console.log();
    console.log('Graphs generated thanks to http://kaaes.github.io/timing/');
    console.log('Browser logos thanks to https://github.com/alrra/browser-logos');
    console.log();
  });


var dir = path.join(__dirname, '../test/templates');
var body = fs.readFileSync(path.join(dir, 'index.html'), 'utf8');

var argv = process.argv.slice(2);
var json = require(path.resolve(argv[0]));
var browser = nopt.browser || '';

var hogan = require('hogan.js');
var tpl = hogan.compile(body);

var title = '';
if (process.env.BUILD_NUMBER) title = 'This page shows raw metrics generated by saucelabs-browsertime for the build ' + process.env.BUILD_NUMBER;

var data = {
  title: title,
  browser: browser,
  metrics: json.tests.map(function(t) {
    t.timingsJSON = JSON.stringify(t.duration.timings);
    return t;
  })
};

console.log(tpl.render(data));

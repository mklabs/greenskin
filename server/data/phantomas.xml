
<?xml version="1.0" encoding="UTF-8"?><project>
  <actions/>
  <description>Testing out phantomas metrics</description>
  <logRotator class="hudson.tasks.LogRotator">
    <daysToKeep>-1</daysToKeep>
    <numToKeep>3</numToKeep>
    <artifactDaysToKeep>-1</artifactDaysToKeep>
    <artifactNumToKeep>-1</artifactNumToKeep>
  </logRotator>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>GRAPHITE_SERVER</name>
          <description>Remote graphite server to send data to</description>
          <defaultValue>192.168.33.33</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>GRAPHITE_PORT</name>
          <description/>
          <defaultValue>8125</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>PERF_URLS</name>
          <description>List of monitoring URLs. Whitespace separated.</description>
          <defaultValue>http://travel.kelkoo.co.uk http://voyages.kelkoo.fr http://voyages.kelkoo.fr http://viaggi.kelkoo.it/ http://viajes.kelkoo.es/</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>JSON_CONFIG</name>
          <description>Phantomas JSON config.</description>
          <defaultValue>{"film-strip":true,"no-externals":true,"allow-domain":".kk-data.com","asserts":{"notFound":0,"onDOMReadyTime":1500}}</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>DEBUG</name>
          <description>Log debug option</description>
          <defaultValue>*</defaultValue>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers>
    <hudson.triggers.TimerTrigger>
      <spec>*/30 * * * *</spec>
    </hudson.triggers.TimerTrigger>
  </triggers>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>[ -e node_modules ] || npm install phantomas debug async optimist tap-eater mkdirp</command>
    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command>#!/usr/bin/env node

var path = require('path');
var fs = require('fs');
var base = path.resolve('node_modules');

var phantomas = require(path.join(base, 'phantomas'));
var async = require(path.join(base, 'async'));
var debug = require(path.join(base, 'debug'))('phantomas:cli');
var mkdirp = require(path.join(base, 'mkdirp'));

var options = {};
var runs;
var program = require(path.join(base, 'optimist'))('phantomas:cli');

// parse options
program
  .usage('PhantomJS-based web performance metrics collector\n\nphantomas &lt;url&gt; [options]')

  // mandatory
  .describe('url', 'Set URL to work with').string('url')

  // version / help
  .describe('version', 'Show version number and quit').boolean('version').alias('version', 'V')
  .describe('help', 'This help text').boolean('help').alias('help', 'h')

  // optional params
  .describe('allow-domain', 'allow requests to given domain(s) - aka whitelist [domain],[domain],...')
  .describe('block-domain', 'disallow requests to given domain(s) - aka blacklist [domain],[domain],...')
  .describe('config', 'uses JSON-formatted config file to set parameters')
  .describe('cookie', 'document.cookie formatted string for setting a single cookie (e.g. "bar=foo;domain=url")')
  .describe('cookies-file', 'specifies the file name to store the persistent Cookies')
  .describe('disable-js', 'disable JavaScript on the page that will be loaded').boolean('disable-js')
  .describe('ignore-ssl-errors', 'ignores SSL errors, such as expired or self-signed certificate errors')
  .describe('log', 'log to a given file')
  .describe('modules', 'run selected modules only [moduleOne],[moduleTwo],...')
  .describe('phone', 'force viewport and user agent of a mobile phone')
  .describe('no-externals', 'block requests to 3rd party domains').boolean('no-externals')
  .describe('post-load-delay', 'wait X seconds before generating a report')
  .describe('progress', 'shows page loading progress bar (disables verbose mode)').boolean('progress')
  .describe('proxy', 'specifies the proxy server to use (e.g. --proxy=192.168.1.42:8080)')
  .describe('proxy-auth', 'specifies the authentication information for the proxy (e.g. --proxy-auth=username:password)')
  .describe('proxy-type', 'specifies the type of the proxy server [http|socks5|none]')
  .describe('reporter', 'output format / reporter').default('reporter', 'statsd').alias('reporter', 'R').alias('reporter', 'format')
  .describe('runs', 'number of runs to perform')
  .describe('screenshot', 'render fully loaded page to a given file')
  .describe('har', 'save HAR to a given file')
  .describe('silent', 'don\'t write anything to the console').boolean('silent')
  .describe('skip-modules', 'skip selected modules [moduleOne],[moduleTwo],...')
  .describe('tablet', 'force viewport and user agent of a tablet')
  .describe('timeout', 'timeout for phantomas run').default('timeout', 15)
  .describe('user-agent', 'provide a custom user agent')
  .describe('verbose', 'writes debug messages to the console').boolean('verbose').alias('verbose', 'v')
  .describe('viewport', 'phantomJS viewport dimensions [width]x[height [default: 1280x1024]')
  .describe('wait-for-selector', 'wait for an element matching given CSS selector before generating a report')

  // experimental features
  .describe('analyze-css', 'emit in-depth CSS metrics - EXPERIMENTAL').boolean('analyze-css')
  .describe('film-strip', 'register film strip when page is loading - EXPERIMENTAL').boolean('film-strip')
  .describe('film-strip-dir', 'folder path to output film strip (default is ./filmstrip directory) - EXPERIMENTAL');

// parse it
options = program.parse(process.argv);
debug('Command line options: %j', options);

var config = JSON.parse(process.env.JSON_CONFIG);
fs.writeFileSync('config.json', JSON.stringify(config));

options.config = 'config.json';

options['statsd-host'] = process.env.GRAPHITE_SERVER || 'localhost';
options['statsd-port'] = process.env.GRAPHITE_PORT || 8125;
options['statsd-prefix'] = process.env.JOB_NAME + '.$url';

debug('Command line options: %j', options);

var urls = process.env.PERF_URLS.split(' ');

// perform a single run
function task(callback) {
  // spawn phantomas process
  var child = phantomas(url, options, function(err, data, results) {
    callback(err === 0 ? null : err, results);
  });

  // pipe --verbose messages to stderr
  child.stderr.pipe(process.stderr);
}

// Helper to cleanup URL for filesystem I/O or graphite keys
function cleanUrl(url) {
  return url
    .replace(/^https?:\/\//, '')
    .replace(/\/$/g, '')
    .replace(/(\/|\?|-|&amp;|=|\.)/g, '_');
}

// @see https://github.com/caolan/async#seriestasks-callback
var series = [];

runs = parseInt(options.runs || 1, 10);
debug('Preparing %d run(s)...', runs);

for (var r=0; r&lt;runs; r++) {
  series.push(task);
}

var urlSeries = urls.map(function(url) {
  return function(callback) {
    // spawn phantomas process

    var urlGraphite = cleanUrl(url);
    var buildId = process.env.BUILD_NUMBER;
    var dir = path.join('results', buildId, urlGraphite);

    var prefix = options['statsd-prefix'];
    prefix = prefix.replace(/\$url/, urlGraphite);
    options['statsd-prefix'] = prefix + '.';

    options.har = path.join(dir, 'har.json');
    options['film-strip-dir'] = path.join(dir, 'filmstrip');

    var child = phantomas(url, options, function(err, data, results) {
      callback(err === 0 ? null : err, results);
    });

    // pipe --verbose messages to stderr
    child.stderr.pipe(process.stderr);
  };
});

// TODO: Handle multiple runs
async.series(
  urlSeries,
  function(err, results) {
    var debug = require(path.join(base, 'debug'))('phantomas:runs');

    debug('err: %j', err);
    debug('results: %j', results);

    // this function is called when phantomas is done with all runs
    function doneFn() {
      // pass error code from PhantomJS process
      debug('Exiting with code #%d', err);
      process.exit(err);
    }

    // process JSON results by reporters
    debug('%d of %d run(s) completed with exit code #%d', results.length, runs, err);

    var reporter = require(path.join(base, 'phantomas/reporters/statsd'));
    var tap = require(path.join(base, 'phantomas/reporters/tap'));

    debug('Calling reporters...');

    async.each(results, function(result, callback) {
      var resTap = tap(result, options).render(function() {});

      console.error(result);
      var url = result.getUrl();

      // Clean up the URL for Filesystem I/O
      url = cleanUrl(url);
      var dir = path.join('results', process.env.BUILD_NUMBER, url);

      debug('URL', result.getUrl(), url);
      console.error(resTap);

      debug('Creating DIR', dir);
      mkdirp.sync(dir);

      var tapfile = path.join(dir, 'results.tap');

      debug('Writing TAP results to', tapfile);
      fs.writeFileSync(tapfile, resTap);

      debug('Writing TAP results to', 'latest.tap');
      fs.writeFileSync('latest.tap', resTap);
        
      reporter(result, options).render(callback);
    }, doneFn);
  }
);


</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <org.tap4j.plugin.TapPublisher plugin="tap@1.18">
      <testResults>latest.tap</testResults>
      <failIfNoResults>false</failIfNoResults>
      <failedTestsMarkBuildAsFailure>false</failedTestsMarkBuildAsFailure>
      <outputTapToConsole>false</outputTapToConsole>
      <enableSubtests>false</enableSubtests>
      <discardOldReports>false</discardOldReports>
      <todoIsFailure>false</todoIsFailure>
      <includeCommentDiagnostics>false</includeCommentDiagnostics>
      <validateNumberOfTests>false</validateNumberOfTests>
      <planRequired>true</planRequired>
    </org.tap4j.plugin.TapPublisher>
  </publishers>
  <buildWrappers/>
</project>
<!doctype html>
<!--[if lt IE 7]>  <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>gs</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="./bower_components/bootstrap/dist/css/bootstrap.css">
  </head>
  <body ng-app="gs">
    <nav class="navbar navbar-default navbar-static-top app-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header navbar-brand">
          <a href="/#/" class="navbar-link">
            <span class="glyphicon glyphicon-home"></span>
            Greenskin
          </a>
        </div>
      </div>
    </nav>


    <div class="container-fluid" ng-view></div>

    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/flot/jquery.flot.js"></script>
    <script src="./bower_components/flot/jquery.flot.time.js"></script>
    <script src="./bower_components/angular/angular.js"></script>
    <script src="./bower_components/angular-route/angular-route.js"></script>
    <script src="./bower_components/angular-flot/angular-flot.js"></script>

    <script src="job-controller.js"></script>
    <script>

      angular.module('gs', [ 'ngRoute', 'angular-flot' ] )

        // Config
        .constant('jenkinsUrl', 'http://dc1-se-prod-kkspeed-01.prod.dc1.kelkoo.net:8080/')
        .constant('graphiteUrl', 'http://dc1-se-prod-admin-02.prod.dc1.kelkoo.net/')
        .constant('ignoredJobs', ['mailer', 'witbe', 'cleanup', 'Travel', 'statsd', 'webdriver_kill', 'webpagetest'])

        // Routes
        .config(['$routeProvider', function($routeProvider) {
          $routeProvider
            .when('/', {
              templateUrl: 'list.html',
              controller: 'ListController'
            })
            .when('/job/:name', {
              templateUrl: 'job.html',
              controller: 'JobController',
              reloadOnSearch: false
            })
            .otherwise({
              redirectTo: '/'
            });
        }])

        // Service
        .factory('jenkins', function($http, jenkinsUrl) {
          var jenkins = {};

          jenkins.list = function list() {
            return $http({
              method: 'JSONP',
              url: jenkinsUrl + 'api/json?jsonp=JSON_CALLBACK'
            });
          };


          jenkins.job = function job(name) {
            return $http({
              method: 'JSONP',
              url: jenkinsUrl + 'job/' + name + '/api/json?jsonp=JSON_CALLBACK'
            });
          };

          jenkins.build = function build(name, build) {
            return $http({
              method: 'JSONP',
              url: jenkinsUrl + 'job/' + name + '/' + build + '/api/json?jsonp=JSON_CALLBACK'
            });
          };

          jenkins.config = function config(name) {
            return $http({
              url: jenkinsUrl + 'job/' + name + '/config.xml'
            });
          };

          jenkins.postConfig = function config(name, xml) {
            return $http({
              method: 'POST',
              url: jenkinsUrl + 'job/' + name + '/config.xml',
              data: xml
            });
          };

          return jenkins;
        })

        .factory('graphite', function($http, graphiteUrl) {
          var graphite = {};

          graphite.metrics = function(builtOn, name) {
            return $http({
              url: graphiteUrl + 'metrics/find?query=greenskin.' + builtOn + '.' + name + '.*.*'
            });
          };


          graphite.render = function(target, from) {
            return $http({
              url: graphiteUrl + 'render?target=' + target + '&format=json' +
                (from ? '&from=' + from : '')
            });
          };

          return graphite;
        })

        // Controllers
        .controller('ListController', function($scope, $http, jenkins, ignoredJobs, jenkinsUrl) {

          $scope.jenkinsUrl = jenkinsUrl;

          jenkins.list().success(function(data) {
            $scope.jobs = data.jobs.filter(function(job) {
              return ignoredJobs.filter(function(ignored) {
                return job.name.indexOf(ignored) !== -1;
              }).length === 0;
            });
          });

        })

        .controller('JobController', JobController);


    </script>
  </body>
</html>

require.def("tabs/search",["domplate/domplate","core/lib","i18n!nls/search","domplate/toolbar","domplate/popupMenu","core/cookies","core/dragdrop"],function(Domplate,Lib,Strings,Toolbar,Menu,Cookies,DragDrop){with(Domplate){var Search={},caseSensitiveOption="searchCaseSensitive";Search.Box=domplate({tag:SPAN({"class":"searchBox"},SPAN({"class":"toolbarSeparator resizer"},"&nbsp;"),SPAN({"class":"searchTextBox"},INPUT({"class":"searchInput",type:"text",placeholder:Strings.search,onkeydown:"$onKeyDown"}),SPAN({"class":"arrow",onclick:"$onOpenOptions"},"&nbsp;"))),onKeyDown:function(a){var b=$.event.fix(a||window.event),c=Lib.getAncestorByClass(b.target,"tabBody"),d=Lib.getElementByClass(c,"searchInput");setTimeout(Lib.bindFixed(this.search,this,c,b.keyCode,d.value))},initialize:function(a){var b=Lib.getElementByClass(a,"searchInput"),c=Lib.getElementByClass(a,"resizer");Search.Resizer.initialize(b,c)},search:function(a,b,c){var d=Lib.getElementByClass(a,"searchBox"),e=Lib.getElementByClass(a,"searchInput");e.removeAttribute("status");var f=e.value;if(f!=c||b==13){if(b!=13&&Lib.isWebkit)return;var g=a.repObject.onSearch(f,b);g||e.setAttribute("status","notfound")}},onOpenOptions:function(a){var b=Lib.fixEvent(a);Lib.cancelEvent(a);if(Lib.isLeftClick(a)){var c=b.target,d=this.getMenuItems(c),e=new Menu({id:"searchOptions",items:d});e.showPopup(c)}},getMenuItems:function(a){var b=Lib.getAncestorByClass(a,"tabBody"),c=b.repObject.getSearchOptions();c.push("-"),c.push({label:Strings.caseSensitive,checked:Cookies.getBooleanCookie(caseSensitiveOption),command:Lib.bindFixed(this.onOption,this,caseSensitiveOption)});return c},onOption:function(a){Cookies.toggleCookie(a);var b=Lib.getElementByClass(document.documentElement,"searchInput");b.removeAttribute("status")}}),Search.ObjectSearch=function(a,b,c,d){this.text=a,this.reverse=c,this.caseSensitive=d,this.stack=[],this.stack.push({object:b,propIndex:0,startOffset:-1}),this.matches=[]},Search.ObjectSearch.prototype={findNext:function(a){while(this.stack.length>0){var b=this.getCurrentScope(),c=this.find(b);if(c)return c}return!1},find:function(a){var b=0;for(var c in a.object){b++;if(a.propIndex>=b)continue;var d=a.object[c];if(!d)continue;a.propIndex=b;if(typeof d=="object"){this.stack.push({propIndex:0,object:d,startOffset:-1});return!1}var e=this.text,f=d+"";Cookies.getBooleanCookie(caseSensitiveOption)||(f=f.toLowerCase(),e=e.toLowerCase());var g=a.startOffset<0?0:a.startOffset,h=f.indexOf(e,g);if(h>=0){a.propIndex+=-1,a.startOffset=h+e.length,this.matches.push({value:d,startOffset:h});return!0}}this.stack.pop();return!1},getCurrentScope:function(){return this.stack[this.stack.length-1]},getCurrentMatch:function(){return this.matches[this.matches.length-1]},selectText:function(a){var b=this.getCurrentMatch();Lib.selectElementText(a,b.startOffset,b.startOffset+this.text.length)}},Search.Resizer=domplate({initialize:function(a,b){this.searchInput=a,this.tracker=new DragDrop.Tracker(b,{onDragStart:Lib.bind(this.onDragStart,this),onDragOver:Lib.bind(this.onDragOver,this),onDrop:Lib.bind(this.onDrop,this)})},onDragStart:function(a){var b=Lib.getBody(this.searchInput.ownerDocument);b.setAttribute("vResizing","true"),this.startWidth=this.searchInput.clientWidth-20},onDragOver:function(a,b){var c=this.startWidth-a.x,d=Lib.getAncestorByClass(this.searchInput,"toolbar");c<=d.clientWidth-40&&(this.searchInput.style.width=c+"px")},onDrop:function(a){var b=Lib.getBody(this.searchInput.ownerDocument);b.removeAttribute("vResizing")}});return Search}})